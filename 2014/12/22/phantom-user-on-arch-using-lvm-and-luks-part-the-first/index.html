<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Website Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Hello everyone! It’s been quite a while since I’ve last updated this website; I’ve been busy graduating from University and moving out to North Carolina to start my new job (I’ll do a more personal bl">
<meta property="og:type" content="article">
<meta property="og:title" content="Website Test">
<meta property="og:url" content="http://new.andrewsiemen.com/2014/12/22/phantom-user-on-arch-using-lvm-and-luks-part-the-first/index.html">
<meta property="og:site_name" content="Website Test">
<meta property="og:description" content="Hello everyone! It’s been quite a while since I’ve last updated this website; I’ve been busy graduating from University and moving out to North Carolina to start my new job (I’ll do a more personal bl">
<meta property="og:updated_time" content="2017-01-17T22:44:06.728Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Website Test">
<meta name="twitter:description" content="Hello everyone! It’s been quite a while since I’ve last updated this website; I’ve been busy graduating from University and moving out to North Carolina to start my new job (I’ll do a more personal bl">
  
    <link rel="alternate" href="/atom.xml" title="Website Test" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Website Test</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">The all new andrewsiemen.com!</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://new.andrewsiemen.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-phantom-user-on-arch-using-lvm-and-luks-part-the-first" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/22/phantom-user-on-arch-using-lvm-and-luks-part-the-first/" class="article-date">
  <time datetime="2014-12-22T04:37:25.000Z" itemprop="datePublished">2014-12-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Uncategorized/">Uncategorized</a>
  </div>

  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Hello everyone! It’s been quite a while since I’ve last updated this website; I’ve been busy graduating from University and moving out to North Carolina to start my new job (I’ll do a more personal blog post at a later time detailing my thoughts on everything about this). I’ll try to stay more on top of this blog, I promise!</p>
<p>Lots has changed; I’m still running <strong>an</strong> ESXi server, but it’s no longer the Dell Optiplex that it was before (it’s actually an old Mac Pro!) and it’s not doing nearly as much as it used to; now that I have a ‘big people job’ and a little bit more dispensable income I’ve moved most of my services off to VPSes (including this blog you’re reading right now!). It just makes more sense to me. I’ll show all of my home network changes soon enough for those that are interested (for whatever reason).</p>
<p>So. On to the topic du jour. This is going to be long and kind of rambly.</p>
<p>The topic for today was inspired by one of my coworkers; he’s running Funtoo on a ThinkPad X1 Carbon, and in order to get to any of his stuff (home directory, in particular) he has to log in as the root user, unlock the home partition, mount it, <em>then</em> log in as himself.<br>“If a bad guy somehow manages to guess my user’s password, he won’t have any of my files; he’ll just have a ‘dummy user’ instead” was his reasoning for this.<br>I thought this was brilliant, so I set off to do this myself on a shiny might-as-well-be-new Lenovo ThinkPad T420 that I picked up for a great price on eBay.</p>
<p>I didn’t see any of the commands he ran when he did this, I just had a good idea of the methodology behind it; encrypt home directory and mount it manually. The details of implementation were up to me.</p>
<p>Let’s get started, shall we?</p>
<p>So first I had to decide what OS I wanted to throw onto this laptop. I originally considered Gentoo because I have been playing with it in a virtual machine and am liking all of the stuff that it can do, but ultimately I decided that I didn’t want to have to wait three hours to compile a software package and all of its dependencies, and all of their dependencies… yadda yadda. So I decided to go back to my old friend Arch; still has the minimalistic “install it from scratch, kind of” mentality, but with a quicker package installation time. Priorities.</p>
<p>(side note: I’m gonna at least try to install Linux from scratch at some point. Just because.)</p>
<p>So there were a couple of attempts at installing a GPT scheme on the hard drive, but a little bit of Googling told me that the motherboards of these older ThinkPads, despite having a “UEFI-flavored BIOS” on them, are unable to read/boot from GPTs. Curses.</p>
<p>Then I started reading up on this fancy “LUKS on LVM” methodology. Basically, you create two partitions on your hard drive (/dev/sda1 and /dev/sda2, in my case). You use the smaller partition (sda1) for your /boot partition, because it needs to remain unencrypted for the BIOS to be able to read from it. Then you split the larger partition (sda2) into pieces using LVM. <em>Then</em> what you can do is encrypt each of those LVM pieces (called Logical Volumes) separately using dm-crypt (LUKS). You can then choose to decrypt some or all of those partitions as the kernel boots up, or manually after boot-time.<br>Plus, because you only need two physical hard disk partitions, it will play nicely with the MBR partition table that I had to use to get the disk to boot, but I could have as many ‘partitions’ as I wanted through the use of LVM.</p>
<p>Perfect.</p>
<p>So I set off, using parted to create the MBR and the two partitions (I could’ve used fdisk, but I was still in a “install it like Gentoo!” mentality for some reason). Then comes the fun part; creating the LVM volumes and encrypting them.</p>
<p>Ideally you’d want to scramble the partition you were going to use for LVM before doing this (by dd’ing from /dev/random to /dev/sda2, for instance), but because this was a hard drive that I had no data on previously I will lose no sleep over not doing so.</p>
<p>Step 1 - create the LVM setup.<br>-Create the ‘physical volume’ (tell the LVM service that this drive is going to have some LVM bits on it),<br>-Create the ‘volume group’ (a ‘container’ for each of the LVM chunks. I think of this in terms of being a “virtual hard drive” because it’s kind of partitioned in the same way), and<br>-Create the ‘logical volumes’ (the actual ‘partitions’ or the ‘LVM chunks’ that we’re going to use to actually store the data).</p>
<p><pre>lvm pvcreate /dev/sda2<br>lvm vgcreate lvm /dev/sda2<br>lvm lvcreate -L 50G -n lvroot lvm<br>lvm lvcreate -L 16G -n swap lvm<br>lvm lvcreate -l 100%FREE -n home lvm<br></pre><br>My partitioning scheme for the LVM logical volumes: 50G for /, 16G for swap (8GB of RAM in the machine and I like the having-double-the-amount-of-RAM-for-swap-space methodology), and the rest of the open space for /home.</p>
<p>Next, we encrypt the device we’re going to use for the root directory.</p>
<p><pre>cryptsetup luks /dev/lvm/lvroot<br></pre><br>It will ask for a password. You’re going to have to enter this password every time the computer starts up, so make it secure but don’t make it unmanagable (a 50-character password, while awesomely secure, is also rather inconvenient to enter every time you have to reboot).</p>
<p>Now, open the freshly encrypted device, create a filesystem on it, and mount it to /mnt to continue installing Arch. The guide I was using suggested using reiserfs, and I’m not really sure why; I just used ext4.</p>
<p><pre>cryptsetup open /dev/lvm/lvroot root #this mounts the unencrypted device at /dev/mapper/root<br>mkfs.ext4 /dev/mapper/root<br>mount /dev/mapper/root /mnt<br></pre><br>Then you mount /dev/sda1 to /mnt/boot, pacstrap, arch-chroot, etc as usual.</p>
<p>Next change comes when it comes to the creation of the initial ramdisk and modifying mkinitcpio.conf. You’ll want to make sure that you have <strong>lvm2</strong> and <strong>encrypt</strong> in your <em>hooks</em> section, and you’ll want to make sure that they’re placed <em>before</em> the <strong>filesystem</strong> hook. This way you make sure that LVM and dm-crypt are started before the kernel tries to load the filesystem.</p>
<p><pre>(chrooted)/etc/mkinitcpio.conf</pre></p>
<p><pre>HOOKS=”… lvm2 encrypt … filesystems …”<br></pre><br>Next comes the configuration of a bootloader. I used GRUB2, so I can’t say for sure whether this procedure will work on Syslinux or Gummiboot or even LILO, so YMMV.</p>
<p>Install the grub package, install GRUB to /dev/sda, and edit the (chrooted)/etc/default/grub file as follows:</p>
<p><pre>GRUB_CMDLINE_LINUX_DEFAULT=”cryptdevice=/dev/lvm/lvroot:root root=/dev/mapper/root resume=/dev/lvm/swap”<br></pre><br>Then generate the GRUB config file.</p>
<p>Finally, you’ll want to configure your filesystem table so the OS knows what to mount and where to find it:</p>
<p><pre>/dev/mapper/root    /               ext4            defaults        0 1</pre></p>
<p>/dev/sda1           /boot           ext2            defaults        0 2</p>
<p>/dev/lvm/swap       none            swap            sw              0 0</p>
<p><br>So why are we listing /dev/mapper/root instead of /dev/lvm/lvroot? Because of the mkinitcpio hook that we added earlier, the lvroot logical volume is decrypted and mounted to /dev/mapper before the kernel ever gets to fstab. And if you think about it, that’s the way it has to be; the kernel can’t read /etc/fstab if everything under / is still encrypted, can it? ;)</p>
<p>Some of you are currently shouting at the screen “WHAT?! Why do you have your swapspace unencrypted?! That’s basically asking for trouble!” Yep. I know. I don’t have a good excuse for it, either; this is just the process that <em>I</em> followed. We’ll get to fancyness with swap in a later post. Hold your horses.</p>
<p>At this point, you’ll want to reboot into your system. You’ll be prompted for your password for the root partition early on; enter it and you’ll be presented with a login prompt. Log in as the root user.</p>
<p>Now, some of you are probably thinking “Hey, wait a second! He hasn’t even touched the /home LVM logical volume! What a scam and a waste of my time, I’m gonna go read slashdot and <em>actually</em> learn something!”</p>
<p>Whoa, there, cowboy. We’re getting to that.</p>
<p>Next, create your “everyday” user; we don’t want to go masquerading around our system as the root user, do we? That’s a <em>very</em> bad idea. Add this user to group ‘wheel’, install ‘sudo’ using pacman, and turn on sudo rights for the ‘wheel’ group using ‘visudo’ (you can even make it passwordless sudo if you want, but keep in mind that anyone that gets to your account basically has root privileges without ever needing to know the password. Weigh the options). Make sure that you create the user’s /home directory as you do this.</p>
<p>Next, finally, go ahead and encrypt the logical volume which is going to be used for the /home directory and actually mount it to /home:</p>
<p><pre>cryptsetup luksFormat /dev/lvm/home<br>cryptsetup open /dev/lvm/home home<br>mount /dev/mapper/home /home<br></pre><br>Physically re-create the user’s home directory and chown it to username:username. Then, logout and log back in as the user. All should seem right with the world. As a test, touch a file in that directory. Why? you’ll see in a second.</p>
<p>Now, go ahead and reboot the machine you’re on. Decrypt the / directory, but don’t decrypt the /home directory. Log in as your user. ‘ls’ your home directory. What do you see?</p>
<p>Nothing. You see absolutely nothing, because your touch’d file is safely encrypted within the /dev/lvm/home logical volume. You’ve successfully set up a ‘dummy’ user; congratulations! :)</p>
<p>Now, you can ‘cd’ out of your home directory (important, otherwise the OS will assume the directory is ‘in use’ and won’t mount anything on top of it), sudo su - to the root user, unencrypt the /dev/lvm/home device, and mount the device to ‘/home’. Then, exit out of the root session and ‘cd’ back home. Voila! All of your file(s) are magically back.</p>
<p>Now, what about that swap issue we were talking about? What if we want hibernate to work with an encrypted swap partition? And that user that we created still has sudo permissions (possibly even paswordless sudo, like in my personal case), that’s still a security risk, how do we mitigate that?</p>
<p>That will have to come in a future blog post. Stay tuned, everyone. :)</p>
<p>/cliffhanger</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://new.andrewsiemen.com/2014/12/22/phantom-user-on-arch-using-lvm-and-luks-part-the-first/" data-id="ciy247jd4000k61bcm326124p" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/01/31/cve-2015-0235-or-why-i-started-worrying-immediately-and-learned-to-give-up-the-ghost/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          CVE-2015-0235, or: why I started worrying immediately and learned to give up the &amp;quot;Ghost&amp;quot;
        
      </div>
    </a>
  
  
    <a href="/2014/03/12/whats-the-big-deal-about-sed-anyways/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">What&#39;s the big deal about sed, anyways?</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Uncategorized/">Uncategorized</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/blog/" style="font-size: 10px;">blog</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/01/17/first-post-hexo/">First post - Hexo!</a>
          </li>
        
          <li>
            <a href="/2017/01/17/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2015/01/31/cve-2015-0235-or-why-i-started-worrying-immediately-and-learned-to-give-up-the-ghost/">CVE-2015-0235, or: why I started worrying immediately and learned to give up the &amp;quot;Ghost&amp;quot;</a>
          </li>
        
          <li>
            <a href="/2014/12/22/phantom-user-on-arch-using-lvm-and-luks-part-the-first/">(no title)</a>
          </li>
        
          <li>
            <a href="/2014/03/12/whats-the-big-deal-about-sed-anyways/">What&#39;s the big deal about sed, anyways?</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Andrew Siemen<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>